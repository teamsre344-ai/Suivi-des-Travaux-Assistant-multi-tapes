{% extends 'base.html' %}
{% load humanize %}

{% block title %}Analytics - CRM{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Analytics</h1>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Projects -->
    <div class="kpi-card kpi-card--total">
        <div>
            <p class="text-sm">Total Projets</p>
            <p class="text-3xl font-bold">{{ total_projects }}</p>
            <p class="text-xs mt-1">+{{ new_this_week }} nouveaux cette semaine</p>
        </div>
    </div>
    <!-- Cancelled Projects -->
    <div class="kpi-card kpi-card--pending">
        <div>
            <p class="text-sm">Annuler</p>
            <p class="text-3xl font-bold">{{ cancelled_projects }}</p>
            <p class="text-xs mt-1">&nbsp;</p> <!-- to keep alignment -->
        </div>
    </div>
    <!-- In Progress Projects -->
    <div class="kpi-card kpi-card--in-progress">
        <div>
            <p class="text-sm">En cours</p>
            <p class="text-3xl font-bold">{{ in_progress_projects }}</p>
            <p class="text-xs mt-1">{{ overdue_in_progress }} en retard</p>
        </div>
    </div>
    <!-- Completed Projects -->
    <div class="kpi-card kpi-card--completed">
        <div>
            <p class="text-sm">Terminés</p>
            <p class="text-3xl font-bold">{{ completed_projects }}</p>
            <p class="text-xs mt-1">{{ completed_this_week }} cette semaine</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Chart 1: Work Type Distribution -->
  <div id="worktypeChartCard" class="rounded-2xl p-5">
    <h3 class="text-lg font-semibold mb-4">Répartition par type de travaux</h3>
    <div class="flex items-center h-80">
        <div class="relative h-full w-1/2"><canvas id="worktypeChart"></canvas></div>
        <div id="worktypeChartLegend" class="w-1/2 pl-4 text-sm"></div>
    </div>
  </div>

  <!-- Chart 2: On-time vs. Overdue -->
  <div id="onTimeChartCard" class="rounded-2xl p-5">
    <h3 class="text-lg font-semibold mb-4">Projets terminés: à temps vs. en retard</h3>
    <div class="flex items-center h-80">
        <div class="relative h-full w-1/2"><canvas id="onTimeChart"></canvas></div>
        <div id="onTimeChartLegend" class="w-1/2 pl-4 text-sm"></div>
    </div>
  </div>

  <!-- Chart 3: Top 10 Clients -->
  <div id="clientChartCard" class="rounded-2xl p-5">
    <h3 class="text-lg font-semibold mb-4">Top 10 des clients</h3>
    <div class="relative h-80"><canvas id="clientChart"></canvas></div>
  </div>

  <!-- Chart 4: Project Status -->
  <div id="statusChartCard" class="rounded-2xl p-5">
    <h3 class="text-lg font-semibold mb-4">Répartition par statut</h3>
    <div class="relative h-80"><canvas id="statusChart"></canvas></div>
  </div>

  <!-- Chart 5: Project Specialist Workflow -->
</div>

<style>
  #chart-modal {
    transition: opacity 0.3s ease;
  }
  #chart-modal .modal-content {
    transition: transform 0.3s ease;
  }
</style>

<div id="chart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" style="opacity: 0;">
  <div class="modal-content rounded-2xl shadow-xl p-5 w-full max-w-4xl h-full max-h-[80vh] transform scale-95">
    <div class="flex justify-between items-center mb-4">
      <h3 id="modal-chart-title" class="text-lg font-semibold"></h3>
      <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
    </div>
    <div class="relative h-[calc(100%-3rem)]">
      <canvas id="modal-chart-canvas"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
(function () {
  const CHART_COLORS = {
    red: 'rgb(255, 99, 132)',
    orange: 'rgb(255, 159, 64)',
    yellow: 'rgb(255, 205, 86)',
    green: 'rgb(75, 192, 192)',
    blue: 'rgb(54, 162, 235)',
    purple: 'rgb(153, 102, 255)',
    grey: 'rgb(201, 203, 207)'
  };


  // Modal Logic
  const modal = document.getElementById('chart-modal');
  const modalContent = modal.querySelector('.modal-content');
  const modalChartTitle = document.getElementById('modal-chart-title');
  const modalCloseBtn = document.getElementById('modal-close-btn');
  const modalCanvas = document.getElementById('modal-chart-canvas');
  let modalChart = null;

  const chartConfigs = {
    'worktypeChart': {
      type: 'doughnut',
      data: {
        labels: [{% for item in worktype_data %}"{{ item.label|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
          data: [{% for item in worktype_data %}{{ item.value }}{% if not forloop.last %}, {% endif %}{% endfor %}],
          backgroundColor: Object.values(CHART_COLORS),
        }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  display: false
              },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          let label = context.label || '';
                          if (label) {
                              label += ': ';
                          }
                          const value = context.raw;
                          const percentage = [{% for item in worktype_data %}{{ item.percentage }}{% if not forloop.last %}, {% endif %}{% endfor %}][context.dataIndex];
                          label += `${value} (${percentage}%)`;
                          return label;
                      }
                  }
              }
          }
      }
    },
    'onTimeChart': {
      type: 'pie',
      data: {
        labels: ['À temps', 'En retard', 'Annulé'],
        datasets: [{
          data: [{{ on_time_count }}, {{ overdue_count }}, {{ cancelled_count }}],
          backgroundColor: [CHART_COLORS.green, CHART_COLORS.red, CHART_COLORS.grey],
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
      }
    },
    'clientChart': {
      type: 'bar',
      data: {
        labels: [{% for l in client_labels %}"{{ l|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
          label: 'Nombre de projets',
          data: [{% for v in client_values %}{{ v }}{% if not forloop.last %}, {% endif %}{% endfor %}],
          backgroundColor: CHART_COLORS.blue,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    },
    'statusChart': {
      type: 'bar',
      data: {
        labels: [{% for l in status_labels %}"{{ l|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
          label: 'Nombre de projets',
          data: [{% for v in status_values %}{{ v }}{% if not forloop.last %}, {% endif %}{% endfor %}],
          backgroundColor: [CHART_COLORS.yellow, CHART_COLORS.blue, CHART_COLORS.green, CHART_COLORS.grey],
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    },
    'specialistChart': {
      type: 'doughnut',
      data: {
        labels: [{% for l in specialist_labels %}"{{ l|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
          data: [{% for v in specialist_values %}{{ v }}{% if not forloop.last %}, {% endif %}{% endfor %}],
          backgroundColor: Object.values(CHART_COLORS),
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed !== null) {
                  const total = {{ total_projects }};
                  const percentage = (context.parsed / total * 100).toFixed(2) + '%';
                  label += `${context.raw} (${percentage})`;
                }
                return label;
              }
            }
          }
        }
      }
    }
  };

  const chartInstances = {};
  // Render charts on page load
  for (const chartId in chartConfigs) {
    const canvas = document.getElementById(chartId);
    if (canvas) {
      chartInstances[chartId] = new Chart(canvas, chartConfigs[chartId]);
    }
  }

  const worktypePercentages = [{% for item in worktype_data %}{{ item.percentage }}{% if not forloop.last %}, {% endif %}{% endfor %}];

  const createCustomLegend = (chart, legendContainerId, percentages) => {
    const legendContainer = document.getElementById(legendContainerId);
    if (!legendContainer) return;
    legendContainer.innerHTML = '';
    const ul = document.createElement('ul');
    ul.style.listStyle = 'none';
    ul.style.padding = '0';

    const data = chart.data;
    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);

    data.labels.forEach((label, i) => {
        const value = data.datasets[0].data[i];
        let percentage;
        if (percentages) {
            percentage = percentages[i];
        } else {
            percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
        }
        const backgroundColor = data.datasets[0].backgroundColor[i];

        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.marginBottom = '8px';

        const colorBox = document.createElement('span');
        colorBox.style.display = 'inline-block';
        colorBox.style.width = '16px';
        colorBox.style.height = '16px';
        colorBox.style.backgroundColor = backgroundColor;
        colorBox.style.marginRight = '8px';
        colorBox.style.borderRadius = '4px';

        const text = document.createElement('span');
        text.innerText = `${label}: ${value} (${percentage}%)`;

        li.appendChild(colorBox);
        li.appendChild(text);
        ul.appendChild(li);
    });

    legendContainer.appendChild(ul);
  };

  if (chartInstances.worktypeChart) {
      createCustomLegend(chartInstances.worktypeChart, 'worktypeChartLegend', worktypePercentages);
  }
  if (chartInstances.onTimeChart) {
      createCustomLegend(chartInstances.onTimeChart, 'onTimeChartLegend', null);
  }

  for (const chartId in chartConfigs) {
    const chartCard = document.getElementById(`${chartId}Card`);
    if (chartCard) {
      chartCard.style.cursor = 'pointer';
      chartCard.addEventListener('click', () => {
        const chartTitle = chartCard.querySelector('h3').innerText;

        modalChartTitle.innerText = chartTitle;

        if (modalChart) {
          modalChart.destroy();
        }

        // Create a deep copy of the config to avoid modifying the original
        const modalChartConfig = JSON.parse(JSON.stringify(chartConfigs[chartId]));
        
        // The tooltip functions are not copied by JSON.stringify, so we restore them from the original config
        if (chartConfigs[chartId].options.plugins && chartConfigs[chartId].options.plugins.tooltip) {
            modalChartConfig.options.plugins.tooltip = chartConfigs[chartId].options.plugins.tooltip;
        }
        
        modalChartConfig.options.maintainAspectRatio = false;

        modalChart = new Chart(modalCanvas, modalChartConfig);

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
          modal.style.opacity = '1';
          modalContent.style.transform = 'scale(1)';
        }, 10);
      });
    }
  }

  function closeModal() {
    modal.style.opacity = '0';
    modalContent.style.transform = 'scale(0.95)';
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      if (modalChart) {
        modalChart.destroy();
        modalChart = null;
      }
    }, 300);
  }

  modalCloseBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });
})();
</script>
{% endblock %}
