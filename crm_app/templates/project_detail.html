{% extends "base.html" %}
{% load static humanize %}

{% block content %}
<div class="container my-4">

  <!-- Back to list -->
  <div class="text-end mb-2">
    <a class="link-secondary small" href="{% url 'project_list' %}">Retour à la liste</a>
  </div>

  <!-- SUMMARY STRIP -->
  <div class="card mb-3 elevated-card">
    <div class="card-body d-flex flex-wrap gap-3 align-items-center">
      <div>Créé par <strong>{{ project.created_by.first_name }} {{ project.created_by.last_name }}</strong> le {{ project.created_at|date:"d/m/Y H:i" }}</div>
      <span class="text-muted">•</span>
      {% if technician and technician.user_id == request.user.id %}
        <span class="badge text-bg-light border">C’est votre projet</span>
      {% endif %}
      <span class="text-muted">•</span>
      <div>Assigné à <strong>
        {% if project.assigned_to %}
          {{ project.assigned_to.first_name }} {{ project.assigned_to.last_name }}
        {% else %}—{% endif %}
      </strong></div>
      <span class="text-muted">•</span>
      <div>No: <strong>{{ project.project_number }}</strong></div>
      <div class="ms-auto">
        <a href="{% url 'project_update' project.id %}" class="px-6 py-2.5 rounded-full bg-indigo-600 text-white font-semibold shadow-sm hover:bg-indigo-700 active:scale-[0.99] transition">
          Modifier le projet
        </a>
      </div>
    </div>
  </div>


  <div class="row g-3">
    <!-- LEFT COLUMN -->
    <div class="col-lg-8">

      <!-- Informations -->
      <div class="card mb-3 elevated-card">
        <div class="card-header"><strong>Informations</strong></div>
        <div class="card-body">
          <div class="row gy-2">
            <div class="col-sm-6"><div class="text-muted small">Client</div><div class="fw-semibold">{{ project.client_name }}</div></div>
            <div class="col-sm-6"><div class="text-muted small">Produit</div><div class="fw-semibold">{{ project.product }}</div></div>

            <div class="col-sm-6"><div class="text-muted small">Environnement</div><div class="fw-semibold">{{ project.get_environment_display }}</div></div>
            <div class="col-sm-6"><div class="text-muted small">Type</div><div class="fw-semibold">{{ project.get_work_type_display }}</div></div>

            <div class="col-sm-6"><div class="text-muted small">Serveur BD</div><div class="fw-semibold">{{ project.db_server|default:"—" }}</div></div>
            <div class="col-sm-6"><div class="text-muted small">Serveur App</div><div class="fw-semibold">{{ project.app_server|default:"—" }}</div></div>

            <div class="col-sm-6"><div class="text-muted small">Base de données</div><div class="fw-semibold">{{ project.database_name|default:"—" }}</div></div>
            <div class="col-sm-6">
              <div class="text-muted small">Validations</div>
              <div class="d-flex gap-2 align-items-center">
                <span class="badge {% if project.fuse_validation == 'OK' %}text-bg-success{% else %}text-bg-warning{% endif %}">FUSE {{ project.fuse_validation|default:"NOK" }}</span>
                <span class="badge {% if project.certificate_validation == 'OK' %}text-bg-success{% else %}text-bg-warning{% endif %}">Cert {{ project.certificate_validation|default:"NOK" }}</span>
              </div>
            </div>

            <div class="col-sm-6"><div class="text-muted small">Version actuelle</div><div class="fw-semibold">{{ project.version_actuelle|default:"—" }}</div></div>
            <div class="col-sm-6"><div class="text-muted small">Version à installer</div><div class="fw-semibold">{{ project.version_cible|default:"—" }}</div></div>

            <div class="col-sm-6"><div class="text-muted small">Début</div><div class="fw-semibold">{% if project.start_at %}{{ project.start_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div></div>
            <div class="col-sm-6"><div class="text-muted small">Fin</div><div class="fw-semibold">{% if project.end_at %}{{ project.end_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div></div>

            {% if project.versions_matrix %}
              <div class="col-12">
                <div class="text-muted small mb-1">Tableau des versions (collé)</div>
                <pre class="p-3 rounded border bg-light" style="white-space:pre-wrap">{{ project.versions_matrix }}</pre>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN -->
    <div class="col-lg-4">

      <!-- Chronologie -->
      <div class="card mb-3 elevated-card">
        <div class="card-header"><strong>Chronologie</strong></div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li class="mb-2">
              <div class="fw-semibold">Préparation</div>
              <div class="text-muted small">Démarrée: {% if project.preparation_phase_started_at %}{{ project.preparation_phase_started_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
              <div class="text-muted small">Terminée: {% if project.preparation_phase_completed_at %}{{ project.preparation_phase_completed_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
            </li>
            <li>
              <div class="fw-semibold">Production</div>
              <div class="text-muted small">Démarrée: {% if project.production_phase_started_at %}{{ project.production_phase_started_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
              <div class="text-muted small">Terminée: {% if project.production_phase_completed_at %}{{ project.production_phase_completed_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
            </li>
          </ul>
        </div>
      </div>

    </div>
  </div>

  <!-- PHASES -->
  <div class="card mb-3 elevated-card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Phases du projet</strong>
      <small class="text-muted">{{ project.completion_percentage }}% • {{ 0 }} / 2 phases complétées</small>
    </div>
    <div class="card-body">

      <!-- progress bar (based on checklist completion) -->
      <div class="progress mb-3" style="height:6px">
        <div class="progress-bar" role="progressbar"
             style="width: {{ project.completion_percentage }}%"></div>
      </div>

      <div class="row g-3">

        <!-- Préparation -->
        <div class="col-md-6">
          <div class="border rounded p-3 h-100" style="background: linear-gradient(to bottom right, #e6f0ff, #ffffff);">
            <div class="fw-semibold mb-1">Préparation</div>
            <div class="text-muted small mb-2">{{ project.get_preparation_phase_display|default:"Non démarrée" }}</div>
            <div class="d-flex gap-2">
              <form method="post" action="{% url 'project_phase_update' project.id %}">
                {% csrf_token %}
                <input type="hidden" name="phase" value="preparation">
                <button class="btn btn-sm btn-primary" name="set" value="in_progress"
                        {% if project.preparation_phase != 'not_started' %}disabled{% endif %}>
                  Démarrer
                </button>
              </form>
              <form method="post" action="{% url 'project_phase_update' project.id %}">
                {% csrf_token %}
                <input type="hidden" name="phase" value="preparation">
                <button class="btn btn-sm btn-outline-secondary" name="set" value="completed"
                        {% if project.preparation_phase == 'completed' %}disabled{% endif %}>
                  Terminer
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Production -->
        <div class="col-md-6">
          <div class="border rounded p-3 h-100" style="background: linear-gradient(to bottom right, #e6ffed, #ffffff);">
            <div class="fw-semibold mb-1">Production</div>
            <div class="text-muted small mb-2">{{ project.get_production_phase_display|default:"Non démarrée" }}</div>
            <div class="d-flex gap-2">
              <form method="post" action="{% url 'project_phase_update' project.id %}">
                {% csrf_token %}
                <input type="hidden" name="phase" value="production">
                <button class="btn btn-sm btn-primary" name="set" value="in_progress"
                        {% if project.preparation_phase != 'completed' or project.production_phase != 'not_started' %}disabled{% endif %}>
                  Démarrer
                </button>
              </form>
              <form method="post" action="{% url 'project_phase_update' project.id %}">
                {% csrf_token %}
                <input type="hidden" name="phase" value="production">
                <button class="btn btn-sm btn-outline-secondary" name="set" value="completed"
                        {% if project.production_phase == 'completed' or project.preparation_phase != 'completed' %}disabled{% endif %}>
                  Terminer
                </button>
              </form>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Checklist -->
  <div class="card mb-3 elevated-card">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>Checklist</strong>

      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-primary" href="#" id="oneNoteBtn">Depuis OneNote</a>
        <a class="btn btn-sm btn-primary" href="#" id="confluenceBtn">Depuis Confluence</a>
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'project_checklist_pdf' project.id %}">Export PDF</a>
      </div>
    </div>
    <div class="card-body p-0">
      <div id="oneNoteContainer" style="display: none;" class="p-3">
        <h5>Checklist OneNote</h5>
        <div id="oneNoteEditor" contenteditable="true" class="form-control" style="min-height: 200px;"></div>
        <div class="text-end mt-2">
          <button class="btn btn-sm btn-secondary" id="cancelOneNoteBtn">Annuler</button>
          <button class="btn btn-sm btn-primary" id="saveOneNoteBtn">Enregistrer</button>
        </div>
      </div>

      <div id="confluenceContainer" style="display: none;" class="p-3">
        <h5>Checklist Confluence</h5>
        <p>L'intégration avec Confluence n'est pas encore disponible.</p>
        <div class="text-end mt-2">
          <button class="btn btn-sm btn-secondary" id="cancelConfluenceBtn">Annuler</button>
        </div>
      </div>

      {% for item in project.checklist_items.all %}
        <div class="border-bottom p-3">
          <div class="d-flex align-items-start gap-3">
            <!-- toggle -->
            <form method="post" action="{% url 'checklist_item_toggle' item.id %}">
              {% csrf_token %}
              <input type="hidden" name="completed" value="{% if not item.completed %}1{% else %}0{% endif %}">
              <input class="form-check-input mt-1" type="checkbox" {% if item.completed %}checked{% endif %} onclick="this.form.submit()">
            </form>

            <div class="flex-grow-1">
              <div class="fw-semibold{% if item.completed %} text-decoration-line-through text-muted{% endif %}">
                {{ item.label }}
              </div>

              <!-- notes/images quick form -->
              <form method="post" action="{% url 'checklist_item_add_note' item.id %}" enctype="multipart/form-data" class="mt-2 d-flex flex-wrap gap-2 align-items-center">
                {% csrf_token %}
                <input type="text" name="text" class="form-control form-control-sm" placeholder="Ajouter un commentaire (optionnel)" style="flex:1 1 260px">
                <input type="file" name="images" class="form-control form-control-sm" multiple style="max-width:220px">
                <button class="btn btn-sm btn-outline-primary">Enregistrer</button>
              </form>

              <!-- existing notes/images -->
              {% if item.notes.all or item.images.all %}
                <div class="mt-2 small text-muted">
                  {% for n in item.notes.all %}
                    <div>• {{ n.created_at|date:"d/m/Y H:i" }} — {{ n.text }}</div>
                  {% endfor %}
                  {% if item.images.all %}
                    <div class="mt-1 d-flex flex-wrap gap-2">
                      {% for img in item.images.all %}
                        <a href="{{ img.image.url }}" target="_blank">
                          <img src="{{ img.image.url }}" class="rounded border" style="height:46px;width:auto">
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% empty %}
        <div class="p-3 text-muted">Aucun item de checklist pour l’instant.</div>
      {% endfor %}
    </div>
  </div>

</div>

<style>
  .card{border-radius:.75rem}
  .card-header{background:#f8fafc;font-weight:600}
  pre{white-space:pre-wrap}
</style>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const oneNoteBtn = document.getElementById('oneNoteBtn');
    const confluenceBtn = document.getElementById('confluenceBtn');
    const oneNoteContainer = document.getElementById('oneNoteContainer');
    const confluenceContainer = document.getElementById('confluenceContainer');
    const cancelOneNoteBtn = document.getElementById('cancelOneNoteBtn');
    const cancelConfluenceBtn = document.getElementById('cancelConfluenceBtn');
    const saveOneNoteBtn = document.getElementById('saveOneNoteBtn');
    const oneNoteEditor = document.getElementById('oneNoteEditor');

    oneNoteBtn.addEventListener('click', function(event) {
      event.preventDefault();
      oneNoteContainer.style.display = 'block';
      confluenceContainer.style.display = 'none';
    });

    confluenceBtn.addEventListener('click', function(event) {
      event.preventDefault();
      confluenceContainer.style.display = 'block';
      oneNoteContainer.style.display = 'none';

      const url = `{% url 'checklist_confluence' project.id %}`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          const p = confluenceContainer.querySelector('p');
          p.textContent = data.message;
        })
        .catch(error => console.error('Error:', error));
    });

    cancelOneNoteBtn.addEventListener('click', function() {
      oneNoteContainer.style.display = 'none';
    });

    cancelConfluenceBtn.addEventListener('click', function() {
      confluenceContainer.style.display = 'none';
    });

    saveOneNoteBtn.addEventListener('click', function() {
      const content = oneNoteEditor.innerHTML;
      const url = `{% url 'checklist_save_onenote' project.id %}`;
      const csrfToken = '{{ csrf_token }}';

      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ content: content })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          oneNoteContainer.style.display = 'none';
          // Optionally, refresh the checklist part of the page
        } else {
          alert('Erreur: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Une erreur est survenue.');
      });
    });
  });
</script>
{% endblock %}
