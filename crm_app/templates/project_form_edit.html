{% extends "base.html" %}

{% block container %}
  <div class="w-full max-w-6xl mx-auto px-4 py-6">
{% endblock container %}

{% block title %}
  {% if form.instance.pk %}
    Modifier le projet : {{ form.instance.project_number }}
  {% else %}
    Nouveau Projet
  {% endif %}
{% endblock %}

{% block content %}
  <h1 class="mb-6 text-3xl font-extrabold text-gray-800 tracking-tight">
    {% if form.instance.pk %}
      Modifier le Projet
    {% else %}
      Créer un Nouveau Projet
    {% endif %}
  </h1>

  {% if form.errors %}
    <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 border border-red-200" role="alert">
      <span class="font-medium">Le formulaire contient des erreurs.</span> Veuillez corriger les champs indiqués ci-dessous.
      <ul>
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li><strong>{{ field }}:</strong> {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <style>
    .menu-item {
        transition: all 0.3s ease;
        cursor: pointer;
        padding: 12px 24px;
        border-bottom: 4px solid transparent;
        color: #6b7280; /* gray-500 */
        font-weight: 500;
    }
    .menu-item.active {
        color: #4f46e5; /* indigo-600 */
        border-bottom-color: #4f46e5; /* indigo-600 */
        font-weight: 600;
    }
    .form-section {
        transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
    }
  </style>

  <div class="mb-6 border-b border-gray-200">
      <div id="form-menu" class="flex justify-center -mb-px">
          {% if form.instance.pk %}
          <div class="menu-item active" data-section="0">Détails du projet</div>
          {% endif %}
          <div class="menu-item {% if not form.instance.pk %}active{% endif %}" data-section="1">Informations principales et Planification</div>
          <div class="menu-item" data-section="2">Détails Techniques</div>
      </div>
  </div>

  <form method="post" enctype="multipart/form-data" novalidate autocomplete="off">
    {% csrf_token %}
    <div id="wizard-form">

      <!-- Section détails du projet -->
      {% if form.instance.pk %}
      <div class="form-section bg-white p-6 rounded-xl shadow-sm border w-full">
        {% include "_project_detail_content.html" %}
      </div>
      {% endif %}

      <!-- Section principale -->
      <div class="form-section bg-white p-6 rounded-xl shadow-sm border w-full" {% if form.instance.pk %}style="display: none;"{% endif %}>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <label for="{{ form.project_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Numéro de projet</label>
            {{ form.project_number }}
          </div>
          <div>
            <label for="{{ form.client_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Nom du client</label>
            {{ form.client_name }}
          </div>
          <div>
            <label for="{{ form.environment.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Environnement</label>
            {{ form.environment }}
          </div>
          <div>
            <label for="{{ form.product.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Produit</label>
            {{ form.product }}
          </div>
          <div>
            <label for="{{ form.work_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Type de travaux</label>
            {{ form.work_type }}
          </div>
          <div>
            <label for="{{ form.assigned_to.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Assigné à</label>
            {{ form.assigned_to }}
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mt-6">
            <!-- Préparation -->
            <div class="space-y-4 p-4 rounded-lg bg-blue-50 border border-blue-200">
                <h3 class="text-lg font-bold text-blue-800">Préparation</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                      <label for="{{ form.prep_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                      {{ form.prep_date }}
                    </div>
                    <div>
                      <label for="{{ form.prep_start_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Début</label>
                      {{ form.prep_start_time }}
                    </div>
                    <div>
                      <label for="{{ form.prep_end_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Fin</label>
                      {{ form.prep_end_time }}
                    </div>
                </div>
            </div>
            <!-- Production -->
            <div class="space-y-4 p-4 rounded-lg bg-green-50 border border-green-200">
                <h3 class="text-lg font-bold text-green-800">Production</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                      <label for="{{ form.prod_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                      {{ form.prod_date }}
                    </div>
                    <div>
                      <label for="{{ form.prod_start_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Début</label>
                      {{ form.prod_start_time }}
                    </div>
                    <div>
                      <label for="{{ form.prod_end_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Fin</label>
                      {{ form.prod_end_time }}
                    </div>
                </div>
            </div>
        </div>
      </div>

      <!-- Section technique -->
      <div class="form-section bg-white p-6 rounded-xl shadow-sm border w-full" style="display: none;">
        <div class="flex flex-wrap -mx-3">
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.database_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Nom de la base de données</label>
            {{ form.database_name }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.db_server.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Serveur de BD</label>
            {{ form.db_server }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.app_server.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Serveur applicatif</label>
            {{ form.app_server }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.version_actuelle.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Version actuelle</label>
            {{ form.version_actuelle }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.version_cible.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Version cible</label>
            {{ form.version_cible }}
          </div>
          <div class="w-full px-3 mb-6">
            <label for="{{ form.versions_matrix.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Matrice des versions</label>
            {{ form.versions_matrix }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.fuse_validation.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Validation Fuse</label>
            {{ form.fuse_validation }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.certificate_validation.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Validation Certificat</label>
            {{ form.certificate_validation }}
          </div>
        </div>
      </div>
    </div>

    <!-- Boutons d'action -->
    <div class="mt-8 flex items-center justify-end gap-4">
      <a href="{% url 'project_list' %}" class="text-sm font-semibold text-gray-600 hover:text-gray-800">Annuler</a>
      <button type="submit" id="submit-btn" class="px-6 py-2.5 rounded-full bg-indigo-600 text-white font-semibold shadow-sm hover:bg-indigo-700 active:scale-[0.99] transition">
        {% if form.instance.pk %}
          Enregistrer les modifications
        {% else %}
          Créer le projet
        {% endif %}
      </button>
    </div>
  </form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const formSections = Array.from(document.querySelectorAll('.form-section'));
    const menuItems = Array.from(document.querySelectorAll('.menu-item'));

    function showSection(index) {
        formSections.forEach((section, i) => {
            const sectionElement = section;
            const dataSection = parseInt(section.getAttribute('data-section-index') || i);
            if (dataSection === index) {
                sectionElement.style.display = 'block';
                sectionElement.style.opacity = '1';
                sectionElement.style.transform = 'translateX(0)';
            } else {
                sectionElement.style.display = 'none';
                sectionElement.style.opacity = '0';
                sectionElement.style.transform = 'translateX(20px)';
            }
        });

        menuItems.forEach((item) => {
            const itemIndex = parseInt(item.getAttribute('data-section'));
            if (itemIndex === index) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    menuItems.forEach(item => {
        item.addEventListener('click', () => {
            const sectionIndex = parseInt(item.getAttribute('data-section'));
            showSection(sectionIndex);
        });
    });

    // Assign data-section-index to each form section for reliable selection
    const hasDetailsSection = {% if form.instance.pk %}true{% else %}false{% endif %};
    if (hasDetailsSection) {
        formSections[0].setAttribute('data-section-index', '0');
        formSections[1].setAttribute('data-section-index', '1');
        formSections[2].setAttribute('data-section-index', '2');
    } else {
        formSections[0].setAttribute('data-section-index', '1');
        formSections[1].setAttribute('data-section-index', '2');
    }
    
    // Initial state
    showSection({% if form.instance.pk %}0{% else %}1{% endif %});

    // Pre-fill form for editing
    {% if form.instance.pk %}
    const projectData = {
        project_number: "{{ form.instance.project_number }}",
        client_name: "{{ form.instance.client_name }}",
        environment: "{{ form.instance.environment }}",
        product: "{{ form.instance.product }}",
        work_type: "{{ form.instance.work_type }}",
        assigned_to: "{{ form.instance.assigned_to.pk }}",
        prep_date: "{{ form.instance.prep_date|date:'Y-m-d' }}",
        prep_start_time: "{{ form.instance.prep_start_time|time:'H:i' }}",
        prep_end_time: "{{ form.instance.prep_end_time|time:'H:i' }}",
        prod_date: "{{ form.instance.prod_date|date:'Y-m-d' }}",
        prod_start_time: "{{ form.instance.prod_start_time|time:'H:i' }}",
        prod_end_time: "{{ form.instance.prod_end_time|time:'H:i' }}",
        database_name: "{{ form.instance.database_name }}",
        db_server: "{{ form.instance.db_server }}",
        app_server: "{{ form.instance.app_server }}",
        status: "{{ form.instance.status }}",
        version_actuelle: "{{ form.instance.version_actuelle }}",
        version_cible: "{{ form.instance.version_cible }}",
        sre_name: "{{ form.instance.sre_name }}",
        sre_phone: "{{ form.instance.sre_phone }}",
        versions_matrix: "{{ form.instance.versions_matrix|escapejs }}",
        contact_tech_client_to: "{{ form.instance.contact_tech_client_to|escapejs }}",
        contact_tech_client_cc: "{{ form.instance.contact_tech_client_cc|escapejs }}",
        autres_ressources_client_cc: "{{ form.instance.autres_ressources_client_cc|escapejs }}",
        note_importante: "{{ form.instance.note_importante|escapejs }}",
        taches_installations: "{{ form.instance.taches_installations|escapejs }}",
        gestionnaire_projet: "{{ form.instance.gestionnaire_projet }}",
    };

    for (const [key, value] of Object.entries(projectData)) {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) {
            if (field.tagName === 'SELECT') {
                const option = field.querySelector(`option[value="${value}"]`);
                if (option) {
                    option.selected = true;
                }
            } else {
                field.value = value;
            }
        }
    }
    {% endif %}
});
</script>
{% endblock %}
