{% load static humanize %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- LEFT COLUMN -->
  <div class="lg:col-span-2">
    <!-- Informations -->
    <div class="card">
      <h2 class="card__title"><i class="fa-solid fa-circle-info"></i> Informations</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><div class="text-sm text-gray-400">Client</div><div class="font-semibold">{{ project.client_name }}</div></div>
        <div><div class="text-sm text-gray-400">Produit</div><div class="font-semibold">{{ project.product }}</div></div>
        <div><div class="text-sm text-gray-400">Environnement</div><div class="font-semibold">{{ project.get_environment_display }}</div></div>
        <div><div class="text-sm text-gray-400">Type</div><div class="font-semibold">{{ project.get_work_type_display }}</div></div>
        <div><div class="text-sm text-gray-400">Gestionnaire du projet</div><div class="font-semibold">{{ project.gestionnaire_projet|default:"—" }}</div></div>
        <div><div class="text-sm text-gray-400">Serveur BD</div><div class="font-semibold">{{ project.db_server|default:"—" }}</div></div>
        <div><div class="text-sm text-gray-400">Serveur App</div><div class="font-semibold">{{ project.app_server|default:"—" }}</div></div>
        <div><div class="text-sm text-gray-400">Base de données</div><div class="font-semibold">{{ project.database_name|default:"—" }}</div></div>
        <div>
          <div class="text-sm text-gray-400">Validations</div>
          <div class="flex gap-2 items-center">
            <span class="badge {% if project.fuse_validation == 'OK' %}badge-green{% else %}badge-amber{% endif %}">FUSE {{ project.fuse_validation|default:"NOK" }}</span>
            <span class="badge {% if project.certificate_validation == 'OK' %}badge-green{% else %}badge-amber{% endif %}">Cert {{ project.certificate_validation|default:"NOK" }}</span>
          </div>
        </div>
        <div><div class="text-sm text-gray-400">Version actuelle</div><div class="font-semibold">{{ project.version_actuelle|default:"—" }}</div></div>
        <div><div class="text-sm text-gray-400">Version à installer</div><div class="font-semibold">{{ project.version_cible|default:"—" }}</div></div>
        <div><div class="text-sm text-gray-400">Début</div><div class="font-semibold">{% if project.start_at %}{{ project.start_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div></div>
        <div><div class="text-sm text-gray-400">Fin</div><div class="font-semibold">{% if project.end_at %}{{ project.end_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div></div>
        {% if project.versions_matrix %}
          <div class="md:col-span-2">
            <div class="text-sm text-gray-400 mb-1">Tableau des versions (collé)</div>
            <pre class="p-3 rounded bg-gray-800 text-white text-sm">{{ project.versions_matrix }}</pre>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div>
    <!-- Chronologie -->
    <div class="card">
      <h2 class="card__title"><i class="fa-solid fa-history"></i> Chronologie</h2>
      <ul class="space-y-2">
        <li>
          <div class="font-semibold">Préparation</div>
          <div class="text-sm text-gray-400">Démarrée: {% if project.preparation_phase_started_at %}{{ project.preparation_phase_started_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
          <div class="text-sm text-gray-400">Terminée: {% if project.preparation_phase_completed_at %}{{ project.preparation_phase_completed_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
        </li>
        <li>
          <div class="font-semibold">Production</div>
          <div class="text-sm text-gray-400">Démarrée: {% if project.production_phase_started_at %}{{ project.production_phase_started_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
          <div class="text-sm text-gray-400">Terminée: {% if project.production_phase_completed_at %}{{ project.production_phase_completed_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- PHASES -->
<div class="card mt-6">
  <div class="flex justify-between items-center mb-4">
    <h2 class="card__title"><i class="fa-solid fa-tasks"></i> Phases du projet</h2>
    <small class="text-gray-400">{{ project.completion_percentage }}% • {{ 0 }} / 2 phases complétées</small>
  </div>
  <div class="w-full bg-gray-700 rounded-full h-2.5 mb-4">
    <div class="bg-blue-500 h-2.5 rounded-full" style="width: {{ project.completion_percentage }}%"></div>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Préparation -->
    <div class="phase-card">
      <div class="font-semibold mb-1">Préparation</div>
      <div class="text-sm text-gray-400 mb-2">{{ project.get_preparation_phase_display|default:"Non démarrée" }}</div>
      <div class="flex gap-2">
        <form method="post" action="{% url 'project_phase_update' project.id %}">
          {% csrf_token %}
          <input type="hidden" name="phase" value="preparation">
          <button class="btn btn-sm btn-primary" name="set" value="in_progress" {% if project.preparation_phase != 'not_started' %}disabled{% endif %}>Démarrer</button>
        </form>
        <form method="post" action="{% url 'project_phase_update' project.id %}">
          {% csrf_token %}
          <input type="hidden" name="phase" value="preparation">
          <button class="btn btn-sm btn-secondary" name="set" value="completed" {% if project.preparation_phase == 'completed' %}disabled{% endif %}>Terminer</button>
        </form>
      </div>
    </div>
    <!-- Production -->
    <div class="phase-card">
      <div class="font-semibold mb-1">Production</div>
      <div class="text-sm text-gray-400 mb-2">{{ project.get_production_phase_display|default:"Non démarrée" }}</div>
      <div class="flex gap-2">
        <form method="post" action="{% url 'project_phase_update' project.id %}">
          {% csrf_token %}
          <input type="hidden" name="phase" value="production">
          <button class="btn btn-sm btn-primary" name="set" value="in_progress" {% if project.preparation_phase != 'completed' or project.production_phase != 'not_started' %}disabled{% endif %}>Démarrer</button>
        </form>
        <form method="post" action="{% url 'project_phase_update' project.id %}">
          {% csrf_token %}
          <input type="hidden" name="phase" value="production">
          <button class="btn btn-sm btn-secondary" name="set" value="completed" {% if project.production_phase == 'completed' or project.preparation_phase != 'completed' %}disabled{% endif %}>Terminer</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
  <!-- Timespan -->
  <div class="card">
    <div class="flex justify-between items-center mb-4">
      <h2 class="card__title"><i class="fa-solid fa-clock"></i> Timespan</h2>
      <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#add-timeline-entry-form">Add Entry</button>
    </div>
    <div class="collapse" id="add-timeline-entry-form">
      <form method="post" action="{% url 'timeline_add_entry' project.id %}">
        {% csrf_token %}
        {{ timeline_form.as_p }}
        <button type="submit" class="btn btn-sm btn-primary">Save</button>
      </form>
      <hr class="my-4 border-gray-700">
    </div>
    <ul class="space-y-2">
      {% for entry in project.timeline.all %}
      <li>{{ entry.event_time|date:"d/m/Y H:i" }} - {{ entry.event_label }}</li>
      {% empty %}
      <li class="text-gray-500">No timeline entries yet.</li>
      {% endfor %}
    </ul>
  </div>
  <!-- Checklist -->
  <div class="card">
    <div class="flex justify-between items-center mb-4">
      <h2 class="card__title"><i class="fa-solid fa-check-square"></i> Checklist</h2>
      <div class="flex gap-2">
        <a class="btn btn-sm btn-primary" href="#" id="oneNoteBtn">Depuis OneNote</a>
        <a class="btn btn-sm btn-primary" href="#" id="confluenceBtn">Depuis Confluence</a>
        <a class="btn btn-sm btn-secondary" href="{% url 'project_checklist_pdf' project.id %}">Export PDF</a>
      </div>
    </div>
    <!-- ... rest of the checklist content ... -->
  </div>
</div>
