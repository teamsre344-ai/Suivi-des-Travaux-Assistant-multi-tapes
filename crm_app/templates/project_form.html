{% extends "base.html" %}

{% block container %}
  <div class="w-full max-w-6xl mx-auto px-4 py-6">
{% endblock container %}

{% block title %}
  {% if form.instance.pk %}
    Modifier le projet : {{ form.instance.project_number }}
  {% else %}
    Nouveau Projet
  {% endif %}
{% endblock %}

{% block content %}
  <h1 class="mb-6 text-3xl font-extrabold text-gray-800 tracking-tight">
    {% if form.instance.pk %}
      Modifier le Projet
    {% else %}
      Créer un Nouveau Projet
    {% endif %}
  </h1>

  {% if form.errors %}
    <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 border border-red-200" role="alert">
      <span class="font-medium">Le formulaire contient des erreurs.</span> Veuillez corriger les champs indiqués ci-dessous.
      <ul>
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li><strong>{{ field }}:</strong> {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" novalidate autocomplete="off">
    {% csrf_token %}
    <div id="wizard-form" class="space-y-8">

      <!-- Section principale -->
      <div class="form-section bg-white p-6 rounded-xl shadow-sm border w-full">
        <div class="text-lg font-semibold text-gray-900 mb-4">Informations principales et Planification</div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <label for="{{ form.project_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Numéro de projet</label>
            {{ form.project_number }}
          </div>
          <div>
            <label for="{{ form.client_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Nom du client</label>
            {{ form.client_name }}
          </div>
          <div>
            <label for="{{ form.environment.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Environnement</label>
            {{ form.environment }}
          </div>
          <div>
            <label for="{{ form.product.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Produit</label>
            {{ form.product }}
          </div>
          <div>
            <label for="{{ form.work_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Type de travaux</label>
            {{ form.work_type }}
          </div>
          <div>
            <label for="{{ form.assigned_to.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Assigné à</label>
            {{ form.assigned_to }}
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mt-6">
            <!-- Préparation -->
            <div class="space-y-4 p-4 rounded-lg bg-gray-50 border">
                <h3 class="font-medium text-gray-700">Préparation</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                      <label for="{{ form.prep_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                      {{ form.prep_date }}
                    </div>
                    <div>
                      <label for="{{ form.prep_start_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Début</label>
                      {{ form.prep_start_time }}
                    </div>
                    <div>
                      <label for="{{ form.prep_end_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Fin</label>
                      {{ form.prep_end_time }}
                    </div>
                </div>
            </div>
            <!-- Production -->
            <div class="space-y-4 p-4 rounded-lg bg-gray-50 border">
                <h3 class="font-medium text-gray-700">Production</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                      <label for="{{ form.prod_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                      {{ form.prod_date }}
                    </div>
                    <div>
                      <label for="{{ form.prod_start_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Début</label>
                      {{ form.prod_start_time }}
                    </div>
                    <div>
                      <label for="{{ form.prod_end_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Fin</label>
                      {{ form.prod_end_time }}
                    </div>
                </div>
            </div>
        </div>
      </div>

      <!-- Section technique -->
      <div class="form-section bg-white p-6 rounded-xl shadow-sm border w-full" style="display: none;">
        <div class="text-lg font-semibold text-gray-900 mb-4">Détails Techniques</div>
        <div class="flex flex-wrap -mx-3">
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.database_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Nom de la base de données</label>
            {{ form.database_name }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.db_server.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Serveur de BD</label>
            {{ form.db_server }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.app_server.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Serveur applicatif</label>
            {{ form.app_server }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Statut</label>
            {{ form.status }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.version_actuelle.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Version actuelle</label>
            {{ form.version_actuelle }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.version_cible.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Version cible</label>
            {{ form.version_cible }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.fuse_validation.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Validation Fuse</label>
            {{ form.fuse_validation }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.certificate_validation.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Validation Certificat</label>
            {{ form.certificate_validation }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.tables_m34.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Tables M34</label>
            {{ form.tables_m34 }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.travaux_a_faire.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Travaux à faire</label>
            {{ form.travaux_a_faire }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.responsable_travaux.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Responsable des travaux</label>
            {{ form.responsable_travaux }}
          </div>
        </div>
      </div>

      <!-- Section SRE -->
      <div class="form-section bg-white p-6 rounded-xl shadow-sm border w-full" style="display: none;">
        <div class="text-lg font-semibold text-gray-900 mb-4">Contact SRE</div>
        <div class="flex flex-wrap -mx-3">
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.sre_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Nom SRE</label>
            {{ form.sre_name }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.sre_phone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Téléphone SRE</label>
            {{ form.sre_phone }}
          </div>
        </div>
      </div>

      <!-- Section Matrice des versions -->
      <div class="form-section bg-white p-6 rounded-xl shadow-sm border w-full" style="display: none;">
        <div class="text-lg font-semibold text-gray-900 mb-4">Matrice des versions</div>
        <div>
          <label for="{{ form.versions_matrix.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Matrice des versions</label>
          {{ form.versions_matrix }}
        </div>
      </div>
      
      <!-- Section Communications -->
      <div class="form-section bg-white p-6 rounded-xl shadow-sm border w-full" style="display: none;">
        <div class="text-lg font-semibold text-gray-900 mb-4">Communications Client</div>
        <div class="flex flex-wrap -mx-3">
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.contact_tech_client_to.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Contact technique (À)</label>
            {{ form.contact_tech_client_to }}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.contact_tech_client_cc.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Contact technique (Cc)</label>
            {{ form.contact_tech_client_cc }}
          </div>
          <div class="w-full px-3 mb-6">
            <label for="{{ form.autres_ressources_client_cc.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Autres ressources (Cc)</label>
            {{ form.autres_ressources_client_cc }}
          </div>
          <div class="w-full px-3 mb-6">
            <label for="{{ form.courriel_confirmation_client.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Courriel confirmation client</label>
            {{ form.courriel_confirmation_client }}
          </div>
        </div>
      </div>

      <!-- Autres détails -->
      <div class="form-section bg-white p-6 rounded-xl shadow-sm border w-full" style="display: none;">
        <div class="text-lg font-semibold text-gray-900 mb-4">Autres détails</div>
        <div class="space-y-6">
          <div>
            <label for="{{ form.note_importante.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Note importante</label>
            {{ form.note_importante }}
          </div>
          <div>
            <label for="{{ form.taches_installations.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Tâches d'installations</label>
            {{ form.taches_installations }}
          </div>
          <div>
            <label for="{{ form.gestionnaire_projet.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Gestionnaire de projet</label>
            {{ form.gestionnaire_projet }}
          </div>
          <div>
            <label for="{{ form.equipe_dev_ajouter.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Équipe dev à ajouter</label>
            {{ form.equipe_dev_ajouter }}
          </div>
          <div>
            <label for="{{ form.equipe_integration_ajouter.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Équipe intégration à ajouter</label>
            {{ form.equipe_integration_ajouter }}
          </div>
          <div>
            <label for="{{ form.bi_a_valider.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">BI à valider</label>
            {{ form.bi_a_valider }}
          </div>
          <div>
            <label for="{{ form.autres_produits_verifier.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Autres produits à vérifier</label>
            {{ form.autres_produits_verifier }}
          </div>
        </div>
      </div>
      
      <!-- Fichiers -->
      <div class="form-section bg-white p-6 rounded-xl shadow-sm border w-full" style="display: none;">
        <div class="text-lg font-semibold text-gray-900 mb-4">Fichiers</div>
        <div>
          <label for="{{ form.coordination_board.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Tableau de coordination</label>
          {{ form.coordination_board }}
        </div>
      </div>

    </div>

    <!-- Boutons d'action -->
    <div class="mt-8 flex items-center justify-end gap-4">
      <a href="{% url 'project_list' %}" class="text-sm font-semibold text-gray-600 hover:text-gray-800">Annuler</a>
      <button type="button" id="back-btn" class="px-6 py-2.5 rounded-full bg-gray-300 text-gray-800 font-semibold shadow-sm hover:bg-gray-400 active:scale-[0.99] transition" style="display: none;">Précédent</button>
      <button type="button" id="next-btn" class="px-6 py-2.5 rounded-full bg-indigo-500 text-white font-semibold shadow-sm hover:bg-indigo-600 active:scale-[0.99] transition">Suivant</button>
      <button type="submit" id="submit-btn" class="px-6 py-2.5 rounded-full bg-indigo-600 text-white font-semibold shadow-sm hover:bg-indigo-700 active:scale-[0.99] transition" style="display: none;">
        {% if form.instance.pk %}
          Enregistrer les modifications
        {% else %}
          Créer le projet
        {% endif %}
      </button>
    </div>
  </form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const formSections = Array.from(document.querySelectorAll('.form-section'));
    const backBtn = document.getElementById('back-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    let currentSectionIndex = 0;

    function updateButtons() {
        if (currentSectionIndex === 0) {
            backBtn.style.display = 'none';
        } else {
            backBtn.style.display = 'inline-block';
        }

        if (currentSectionIndex === formSections.length - 1) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'inline-block';
        } else {
            nextBtn.style.display = 'inline-block';
            submitBtn.style.display = 'none';
        }
    }

    function showSection(index) {
        formSections.forEach((section, i) => {
            section.style.display = i === index ? 'block' : 'none';
        });
        currentSectionIndex = index;
        updateButtons();
    }

    nextBtn.addEventListener('click', () => {
        if (currentSectionIndex < formSections.length - 1) {
            showSection(currentSectionIndex + 1);
        }
    });

    backBtn.addEventListener('click', () => {
        if (currentSectionIndex > 0) {
            showSection(currentSectionIndex - 1);
        }
    });

    // Initial state
    showSection(0);

    // Pre-fill form for editing
    {% if form.instance.pk %}
    const projectData = {
        project_number: "{{ form.instance.project_number }}",
        client_name: "{{ form.instance.client_name }}",
        environment: "{{ form.instance.environment }}",
        product: "{{ form.instance.product }}",
        work_type: "{{ form.instance.work_type }}",
        assigned_to: "{{ form.instance.assigned_to.pk }}",
        prep_date: "{{ form.instance.prep_date|date:'Y-m-d' }}",
        prep_start_time: "{{ form.instance.prep_start_time|time:'H:i' }}",
        prep_end_time: "{{ form.instance.prep_end_time|time:'H:i' }}",
        prod_date: "{{ form.instance.prod_date|date:'Y-m-d' }}",
        prod_start_time: "{{ form.instance.prod_start_time|time:'H:i' }}",
        prod_end_time: "{{ form.instance.prod_end_time|time:'H:i' }}",
        database_name: "{{ form.instance.database_name }}",
        db_server: "{{ form.instance.db_server }}",
        app_server: "{{ form.instance.app_server }}",
        status: "{{ form.instance.status }}",
        version_actuelle: "{{ form.instance.version_actuelle }}",
        version_cible: "{{ form.instance.version_cible }}",
        sre_name: "{{ form.instance.sre_name }}",
        sre_phone: "{{ form.instance.sre_phone }}",
        versions_matrix: "{{ form.instance.versions_matrix|escapejs }}",
        contact_tech_client_to: "{{ form.instance.contact_tech_client_to|escapejs }}",
        contact_tech_client_cc: "{{ form.instance.contact_tech_client_cc|escapejs }}",
        autres_ressources_client_cc: "{{ form.instance.autres_ressources_client_cc|escapejs }}",
        note_importante: "{{ form.instance.note_importante|escapejs }}",
        taches_installations: "{{ form.instance.taches_installations|escapejs }}",
        gestionnaire_projet: "{{ form.instance.gestionnaire_projet }}",
    };

    for (const [key, value] of Object.entries(projectData)) {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) {
            if (field.tagName === 'SELECT') {
                const option = field.querySelector(`option[value="${value}"]`);
                if (option) {
                    option.selected = true;
                }
            } else {
                field.value = value;
            }
        }
    }
    {% endif %}
});
</script>
{% endblock %}
