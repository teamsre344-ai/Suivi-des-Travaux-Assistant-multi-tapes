{% extends "base.html" %}
{% load form_extras %}

{% block container %}
  <div class="w-full max-w-6xl mx-auto px-4 py-6">
{% endblock container %}

{% block title %}
  {% if form.instance.pk %}
    Modifier le projet : {{ form.instance.project_number }}
  {% else %}
    Nouveau Projet
  {% endif %}
{% endblock %}

{% block content %}
  <h1 class="mb-6 text-3xl font-extrabold text-gray-800 tracking-tight">
    {% if form.instance.pk %}
      Modifier le Projet
    {% else %}
      Créer un Nouveau Projet
    {% endif %}
  </h1>

  {% if form.errors %}
    <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 border border-red-200" role="alert">
      <span class="font-medium">Le formulaire contient des erreurs.</span> Veuillez corriger les champs indiqués ci-dessous.
      <ul>
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li><strong>{{ field }}:</strong> {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <style>
    .menu-item {
        transition: all 0.3s ease;
        cursor: pointer;
        padding: 12px 24px;
        border-bottom: 4px solid transparent;
        color: #6b7280; /* gray-500 */
        font-weight: 500;
    }
    .menu-item.active {
        color: #4f46e5; /* indigo-600 */
        border-bottom-color: #4f46e5; /* indigo-600 */
        font-weight: 600;
    }
    .form-section {
        transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
    }
  </style>

  <div class="mb-6 border-b border-gray-200">
      <div id="form-menu" class="flex justify-center -mb-px">
          <div class="menu-item active" data-section="0">Informations principales et Planification</div>
          <div class="menu-item" data-section="1">Détails Techniques</div>
          <div class="menu-item" data-section="2" style="display: {% if form.instance.pk %}flex{% else %}none{% endif %};">Détails du projet</div>
      </div>
  </div>

  <form id="project-form" method="post" enctype="multipart/form-data" novalidate autocomplete="off">
    {% csrf_token %}
    <div id="wizard-form">

      <!-- Section principale -->
      <div class="form-section radial-background p-6 rounded-xl shadow-sm border w-full">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <label for="{{ form.project_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Numéro de projet</label>
            {% if is_manager %}{{ form.project_number|add_attr:"disabled:disabled" }}{% else %}{{ form.project_number }}{% endif %}
          </div>
          <div>
            <label for="{{ form.client_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Nom du client</label>
            {% if is_manager %}{{ form.client_name|add_attr:"disabled:disabled" }}{% else %}{{ form.client_name }}{% endif %}
          </div>
          <div>
            <label for="{{ form.environment.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Environnement</label>
            {% if is_manager %}{{ form.environment|add_attr:"disabled:disabled" }}{% else %}{{ form.environment }}{% endif %}
          </div>
          <div>
            <label for="{{ form.product.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Produit</label>
            {% if is_manager %}{{ form.product|add_attr:"disabled:disabled" }}{% else %}{{ form.product }}{% endif %}
          </div>
          <div>
            <label for="{{ form.work_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Type de travaux</label>
            {% if is_manager %}{{ form.work_type|add_attr:"disabled:disabled" }}{% else %}{{ form.work_type }}{% endif %}
          </div>
          <div>
            <label for="{{ form.assigned_to.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Assigné à</label>
            {% if is_manager %}{{ form.assigned_to|add_attr:"disabled:disabled" }}{% else %}{{ form.assigned_to }}{% endif %}
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mt-6">
            <!-- Préparation -->
            <div class="space-y-4 p-4 rounded-lg bg-blue-50 border border-blue-200">
                <h3 class="text-lg font-bold text-blue-800">Préparation</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                      <label for="{{ form.prep_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                      {% if is_manager %}{{ form.prep_date|add_attr:"disabled:disabled" }}{% else %}{{ form.prep_date }}{% endif %}
                    </div>
                    <div>
                      <label for="{{ form.prep_start_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Début</label>
                      {% if is_manager %}{{ form.prep_start_time|add_attr:"disabled:disabled" }}{% else %}{{ form.prep_start_time }}{% endif %}
                    </div>
                    <div>
                      <label for="{{ form.prep_end_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Fin</label>
                      {% if is_manager %}{{ form.prep_end_time|add_attr:"disabled:disabled" }}{% else %}{{ form.prep_end_time }}{% endif %}
                    </div>
                </div>
            </div>
            <!-- Production -->
            <div class="space-y-4 p-4 rounded-lg bg-gradient-to-br from-green-50 to-green-200 border border-green-200">
                <h3 class="text-lg font-bold text-green-800">Production</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                      <label for="{{ form.prod_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                      {% if is_manager %}{{ form.prod_date|add_attr:"disabled:disabled" }}{% else %}{{ form.prod_date }}{% endif %}
                    </div>
                    <div>
                      <label for="{{ form.prod_start_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Début</label>
                      {% if is_manager %}{{ form.prod_start_time|add_attr:"disabled:disabled" }}{% else %}{{ form.prod_start_time }}{% endif %}
                    </div>
                    <div>
                      <label for="{{ form.prod_end_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Fin</label>
                      {% if is_manager %}{{ form.prod_end_time|add_attr:"disabled:disabled" }}{% else %}{{ form.prod_end_time }}{% endif %}
                    </div>
                </div>
            </div>
        </div>
      </div>

      <!-- Section technique -->
      <div class="form-section radial-background p-6 rounded-xl shadow-sm border w-full" style="display: none;">
        <div class="flex flex-wrap -mx-3">
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.database_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Nom de la base de données</label>
            {% if is_manager %}{{ form.database_name|add_attr:"disabled:disabled" }}{% else %}{{ form.database_name }}{% endif %}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.db_server.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Serveur de BD</label>
            {% if is_manager %}{{ form.db_server|add_attr:"disabled:disabled" }}{% else %}{{ form.db_server }}{% endif %}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.app_server.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Serveur applicatif</label>
            {% if is_manager %}{{ form.app_server|add_attr:"disabled:disabled" }}{% else %}{{ form.app_server }}{% endif %}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.version_actuelle.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Version actuelle</label>
            {% if is_manager %}{{ form.version_actuelle|add_attr:"disabled:disabled" }}{% else %}{{ form.version_actuelle }}{% endif %}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.version_cible.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Version cible</label>
            {% if is_manager %}{{ form.version_cible|add_attr:"disabled:disabled" }}{% else %}{{ form.version_cible }}{% endif %}
          </div>
          <div class="w-full px-3 mb-6">
            <label for="{{ form.versions_matrix.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Matrice des versions</label>
            {% if is_manager %}{{ form.versions_matrix|add_attr:"disabled:disabled" }}{% else %}{{ form.versions_matrix }}{% endif %}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.fuse_validation.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Validation Fuse</label>
            {% if is_manager %}{{ form.fuse_validation|add_attr:"disabled:disabled" }}{% else %}{{ form.fuse_validation }}{% endif %}
          </div>
          <div class="w-full md:w-1/2 px-3 mb-6">
            <label for="{{ form.certificate_validation.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Validation Certificat</label>
            {% if is_manager %}{{ form.certificate_validation|add_attr:"disabled:disabled" }}{% else %}{{ form.certificate_validation }}{% endif %}
          </div>
        </div>
      </div>

      <!-- Section détails du projet -->
      {% if form.instance.pk %}
      <div class="form-section radial-background p-6 rounded-xl shadow-sm border w-full" style="display: none;">
        {% include "_project_detail_content.html" %}
      </div>
      {% endif %}
    </div>

    <!-- Boutons d'action -->
    <div id="action-buttons" class="mt-8 flex items-center justify-end gap-4">
      {% if form.instance.pk %}
        <a href="{% url 'project_detail' form.instance.pk %}" class="px-6 py-2.5 rounded-full bg-gray-500 text-white font-semibold shadow-sm hover:bg-gray-600 active:scale-[0.99] transition">Voir le projet</a>
      {% endif %}
      <a href="{% url 'project_list' %}" class="px-6 py-2.5 rounded-full bg-red-500 text-white font-semibold shadow-sm hover:bg-red-600 active:scale-[0.99] transition">Annuler</a>
      <button type="button" id="back-btn" class="px-6 py-2.5 rounded-full bg-gray-300 text-gray-800 font-semibold shadow-sm hover:bg-gray-400 active:scale-[0.99] transition" style="display: none;">Précédent</button>
      <button type="button" id="next-btn" class="px-6 py-2.5 rounded-full bg-indigo-500 text-white font-semibold shadow-sm hover:bg-indigo-600 active:scale-[0.99] transition">Suivant</button>
      {% if not is_manager %}
      <button type="submit" id="submit-btn" class="px-6 py-2.5 rounded-full bg-indigo-600 text-white font-semibold shadow-sm hover:bg-indigo-700 active:scale-[0.99] transition" style="display: none;">
        {% if form.instance.pk %}
          Enregistrer les modifications
        {% else %}
          Créer le projet
        {% endif %}
      </button>
      {% endif %}
    </div>
  </form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const formSections = Array.from(document.querySelectorAll('.form-section'));
    const menuItems = Array.from(document.querySelectorAll('.menu-item'));
    const backBtn = document.getElementById('back-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const form = document.getElementById('project-form');
    let currentSectionIndex = 0;
    let projectId = {{ form.instance.pk|default:"null" }};

    // Force the button container to be visible
    const actionButtons = document.getElementById('action-buttons');
    if (actionButtons) {
        actionButtons.style.display = 'flex';
    }

    function updateButtons() {
        const isFirstSection = currentSectionIndex === 0;
        const isLastSection = currentSectionIndex >= formSections.length - 1;

        backBtn.style.display = isFirstSection ? 'none' : 'inline-block';
        nextBtn.style.display = isLastSection ? 'none' : 'inline-block';
        
        if (submitBtn) {
            submitBtn.style.display = isLastSection ? 'inline-block' : 'none';
        }
    }

    function showSection(index) {
        formSections.forEach((section, i) => {
            const sectionElement = section;
            if (i === index) {
                sectionElement.style.display = 'block';
                sectionElement.style.opacity = '1';
                sectionElement.style.transform = 'translateX(0)';
            } else {
                sectionElement.style.display = 'none';
                sectionElement.style.opacity = '0';
                sectionElement.style.transform = 'translateX(20px)';
            }
        });

        menuItems.forEach((item, i) => {
            if (i === index) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });

        currentSectionIndex = index;
        updateButtons();
    }

    menuItems.forEach(item => {
        item.addEventListener('click', () => {
            const sectionIndex = parseInt(item.getAttribute('data-section'));
            showSection(sectionIndex);
        });
    });

    nextBtn.addEventListener('click', () => {
        if (currentSectionIndex < formSections.length - 1) {
            showSection(currentSectionIndex + 1);
        }
    });

    backBtn.addEventListener('click', () => {
        if (currentSectionIndex > 0) {
            showSection(currentSectionIndex - 1);
        }
    });

    if (submitBtn) {
        submitBtn.addEventListener('click', (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            const url = projectId ? `/projects/ajax/save/${projectId}/` : '/projects/ajax/save/';

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (!projectId && data.pk) {
                        // It's a new project, redirect to the detail page
                        window.location.href = `/projects/${data.pk}/`;
                    } else {
                        // It's an existing project, show a success message and redirect
                        alert('Projet mis à jour avec succès!');
                        window.location.href = `/projects/${projectId}/edit/?section=2`;
                    }
                } else {
                    // Handle errors
                    let errorMessages = 'Le formulaire contient des erreurs:\n';
                    for (const field in data.errors) {
                        errorMessages += `${field}: ${data.errors[field].join(', ')}\n`;
                    }
                    alert(errorMessages);
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                alert('Une erreur est survenue lors de la soumission du formulaire.');
            });
        });
    }

    // Initial state
    const urlParams = new URLSearchParams(window.location.search);
    const sectionParam = urlParams.get('section');
    let initialSection = 0;

    if (projectId && sectionParam !== null) {
        const section = parseInt(sectionParam, 10);
        if (!isNaN(section) && section >= 0 && section < menuItems.length) {
            initialSection = section;
        }
    }
    
    showSection(initialSection);

    // Pre-fill form for editing
    {% if form.instance.pk %}
    const projectDataElement = document.getElementById('project-data');
    if (projectDataElement) {
        try {
            const projectData = JSON.parse(projectDataElement.textContent);
            for (const [key, value] of Object.entries(projectData)) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field && value !== null && value !== undefined) {
                    if (field.tagName === 'SELECT') {
                        const option = Array.from(field.options).find(opt => opt.value == value);
                        if (option) {
                            field.value = value;
                        }
                    } else {
                        field.value = value;
                    }
                }
            }
        } catch (e) {
            console.error("Failed to parse project data JSON:", e);
        }
    }
    {% endif %}
});
</script>

{% if form.instance.pk %}
<script id="project-data" type="application/json">
    {{ form.instance_data_json|safe }}
</script>
{% endif %}
{% endblock %}
